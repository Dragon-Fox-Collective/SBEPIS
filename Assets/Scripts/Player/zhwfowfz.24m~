using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.InputSystem;
using WrightWay.SBEPIS.Util;

namespace WrightWay.SBEPIS.Player
{
	public class SylladexOwner : MonoBehaviour
	{
		public Sylladex sylladex;
		public Transform sylladexParent;
		public ItemHolder itemHolder;
		public PlayerModeSwapper modeSwapper;
		public PlayerInput playerInput;

		private Item retrievingItem;
		private bool _isViewing;
		private bool IsViewing
		{
			get => _isViewing;
			set
			{
				_isViewing = value;
				if (_isViewing)
				{
					playerInput.actions.FindAction("Use").Disable();
					playerInput.actions.FindAction("Captchalogue Mode").Enable();
					sylladexParentRotTarget = Quaternion.identity;
					sylladexParentScaleTarget = Vector3.one;
				}
				else
				{
					playerInput.actions.FindAction("Use").Enable();
					playerInput.actions.FindAction("Captchalogue Mode").Disable();
					sylladexParentRotTarget = Quaternion.AngleAxis(-90, Vector3.up);
					sylladexParentScaleTarget = Vector3.zero;
				}
			}
		}
		private bool _canCaptchalogue;
		private bool CanCaptchalogue
		{
			get => _canCaptchalogue;
			set
			{
				_canCaptchalogue = value;
				if (_canCaptchalogue)
				{
					playerInput.actions.FindAction("Captchalogue").Enable();
					sylladexRotTarget = Quaternion.AngleAxis(-90);
				}
				else
				{
					playerInput.actions.FindAction("Captchalogue").Disable();
				}
			}
		}
		private Quaternion sylladexRotTarget;
		private Quaternion sylladexRotDeriv;
		private Quaternion sylladexParentRotTarget;
		private Quaternion sylladexParentRotDeriv;
		private Vector3 sylladexParentScaleTarget;
		private Vector3 sylladexParentScaleVel;

		private void Start()
		{
			IsViewing = false;
			CanCaptchalogue = false;
		}

		private void Update()
		{
			sylladexParent.localRotation = QuaternionUtil.SmoothDamp(sylladexParent.localRotation, sylladexParentRotTarget, ref sylladexParentRotDeriv, 0.2f);
			sylladexParent.localScale = Vector3.SmoothDamp(sylladexParent.localScale, sylladexParentScaleTarget, ref sylladexParentScaleVel, 0.1f);

			if (retrievingItem)
				itemHolder.UpdateItem(retrievingItem);

		}

		private void OnCaptchalogue()
		{
			Item hitItem;
			if (Physics.Raycast(itemHolder.camera.position, itemHolder.camera.forward, out RaycastHit captchaHit, itemHolder.maxDistance) && captchaHit.rigidbody && (hitItem = captchaHit.rigidbody.GetComponent<Item>()))
				sylladex.Captchalogue(hitItem, this);
		}

		private void OnRetrieve(InputValue value)
		{
			if (value.isPressed && (retrievingItem = sylladex.Display()))
			{
				retrievingItem.gameObject.SetActive(true);
				retrievingItem.transform.SetParent(null);
				retrievingItem.onPickUp.AddListener(Retrieve);
			}
			else if (retrievingItem)
			{
				retrievingItem.onPickUp.RemoveListener(Retrieve);
				retrievingItem.gameObject.SetActive(false);
				retrievingItem.transform.SetParent(sylladex.transform, this);
				retrievingItem = null;
			}
		}

		private void Retrieve(ItemHolder holder)
		{
			sylladex.Retrieve();
			retrievingItem.transform.SetParent(null);
			retrievingItem.onPickUp.RemoveListener(Retrieve);
			retrievingItem = null;
		}

		private void OnViewSylladex()
		{
			IsViewing = !IsViewing;
		}

		private void OnCaptchalogueMode(InputValue value)
		{
			CanCaptchalogue = value.isPressed;
		}
	}
}